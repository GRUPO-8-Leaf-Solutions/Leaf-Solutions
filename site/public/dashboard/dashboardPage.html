<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Leaf - Dashboard</title>

    <link rel="icon" href="../../assets/icon/logo.svg">
    <link rel="stylesheet" href="css/dashboardPage.css">

    <!-- SCRIPT PARA PUXAR A BIBLIOTECA DO CHARTJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
</head>
<!-- onload="coletarMaiorIndice, coletarMaiorIndice" -->

<body>
    <!-- PAG MENU -->
    <div class="container">

        <div class="lateral">
            <!-- parte de cima -->
            <div class="listaBaixo">
                <div class="navegacão">
                    <div class="navHeader">
                        <img src="../assets/icon/logo.svg">
                        <span>MENU</span>
                    </div>
                    <ul>
                        <li class="lista destaque">
                            <a href="dashboardPage.html">
                                <i class="uil uil-create-dashboard"></i>
                                <span class="lista">Dashboard</span>
                            </a>
                        </li>
                        <li class="lista">
                            <a href="estatisticaPage.html">
                                <i class="uil uil-presentation-line"></i>
                                <span class="lista">Estatística</span>
                            </a>
                        </li>
                        <!-- <li class="lista">
                            <a href="previsaoPage.html">
                                <i class="uil uil-chart-pie"></i>
                                <span class="lista">Previsões</span>
                            </a>
                        </li> -->
                        <li class="lista">
                            <a href="historicoPage.html">
                                <i class="uil uil-history"></i>
                                <span class="lista">Histórico</span>
                            </a>
                        </li>
                    </ul>
                    <div class="inferior-menu" style="background-image: url(../assets/imgs/VectorPéMenu.svg);">
                        <ul style="height: fit-content;">
                            <li class="lista">
                                <a href="cadastrarUsuario.html">
                                    <i class="uil uil-plus-circle"></i>
                                    <span class="lista" style="font-size: 15px;">Cadastrar usuario</span>
                                </a>
                            </li>
                            <li class="lista">
                                <a href="cadastrarEstufa.html">
                                    <i class="uil uil-plus-circle"></i>
                                    <span class="lista" style="font-size: 15px;">Cadastrar estufa</span>
                                </a>
                            </li>
                            <!-- <img src="imgs/VectorPéMenu.svg" alt=""> -->
                        </ul>
                    </div>

                </div>

                <!-- parte de baixo -->
                <!-- <div class="trindade">
                    <div class="configNomeimg">
                        <div class="nomeNome">
                            <img src="imgs/Ellipse2325.png">
                            <ul class="ul2">
                                <span class="ismalendas">
                                    <span>NomeUsuario</span>
                                    <span>NomeEmpresa</span>
                                </span>
                            </ul>
                        </div> -->

                <!-- <div class="configgg">
                            <a href="#">
                                <i class="uil uil-setting"></i>
                            </a>
                            <a href="../home/login.html">
                                <i class="uil uil-signout" style="color: #C63535;"></i>
                            </a>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>
        <!-- FIM DO MENU -->

        <!-- parte do dash -->
        <div class="tela">
            <div class="top">
                <div class="top-left">
                    <span class="topo">Dashboard</span>
                </div>
                <div class="nomeNome">
                    <img src="../assets/imgs/Ellipse2325.png">
                    <ul class="ul2">
                        <span class="ismalendas">
                            <span id="loginUsuario"></span>
                            <span>NomeEmpresa</span>
                        </span>
                    </ul>
                </div>
            </div>
            <div class="areaDash">
                <div>
                    <div class="alertsParametro">
                        <div class="urgente">
                            <img src="../assets/imgs/vetorUrgente.svg">
                            <div class="span-urgente">
                                <span class="urgenteText">CRÍTICO</span>
                                <span>350lm - 450lm</span>
                                <span>650lm - 800lm</span>
                            </div>
                        </div>
                        <div class="preocupante">
                            <img src="../assets/imgs/VectorNewProcupante.svg" width="30px">
                            <div class="span-preocupante">
                                <span class="criticoText">PREOCUPANTE</span>
                                <span>450lm - 500lm</span>
                                <span>600lm - 650lm</span>
                            </div>
                        </div>
                        <!-- <div class="critico">
                            <img src="../imgs/vectorPreocupante.svg" width="30px">
                            <span class="preocupanteText">PREOCUPANTE</span>
                        </div> -->
                        <div class="adequado">
                            <img src="../assets/imgs/vetorAdequado.svg">
                            <div class="span-adequado">
                                <span class="adequadoText">ADEQUADO</span>
                                <span>500lm - 600lm</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tela-dashboard">






                <div class="daddy">
                    <div class="main">


                        <div class="containerChart">
                            <div class="tittle_chart">
                                <span>
                                    MEDIA DA LUMINOSIDADE DAS ESTUFAS NAS ULTIMAS 24H
                                </span>
                            </div>
                            <canvas id="myChart1"></canvas>
                        </div>
                        <!-- <div class="containerChart">
                        <div class="chartContainer">
                            <div class="grafico1">
                                <span class="title-Chart"></span>
                                <span class="subTittle-Chart">EM CADA ESTUFA</span>
                            </div>
                        </div>
                    </div> -->

                        <div class="rodape">
                            <div class="ajuste_pie">
                                <p>SITUAÇÃO DAS ESTUFAS</p>
                                <div class="grafico_pie">
                                    <div class="teste">
                                        <canvas id="grafico_pizza"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="indice_luz_pai">
                                <div class="daddy_indice" id="mmIndice">

                                </div>
                                <div class="alerta_estufas">
                                    <div class="ajuste">
                                        <div class="indicativo_alerta_estufas">
                                            Estufas com mais alertas
                                        </div>
                                        <div id="rankEstufas" class="mencao_estufas">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ALERTA URGENTE -->
                    <div class="lado_direito">
                        <div class="tela-alertas">
                            <span class="title-alerta">ALERTAS</span>

                            <div class="listaScroller" id="listaAlert">


                            </div>



                        </div>
                    </div>

                </div>
            </div>
        </div>





</body>
<script>
    // const labels = [
    //     '12:00',
    //     '13:00',
    //     '14:00',
    //     '15:00',
    //     '16:00',
    //     '17:00',
    // ];

    // const data = {
    //     labels: labels,
    //     datasets: [{
    //         label: 'Antônio',
    //         backgroundColor: 'rgb(255, 99, 132)',
    //         borderColor: 'rgb(255, 99, 132)',
    //         data: [],
    //     },
    //     {
    //         label: 'Paulista',
    //         backgroundColor: 'rgb(148, 0, 211)',
    //         borderColor: 'rgb(148, 0, 211)',
    //         data: [],
    //     },
    //     {
    //         label: 'Guimarães',
    //         backgroundColor: 'rgb(18, 10, 143)',
    //         borderColor: 'rgb(18, 10, 143)',
    //         data: [],
    //     }
    //     ]
    // };


</script>

<script>
    // const myChart1 = new Chart(
    //     document.getElementById('myChart1'),
    //     config
    // );
    // const myChart2 = new Chart(
    //     document.getElementById('myChart2'),
    //     config
    // );
</script>

<script>
    const grafico_pie = document.getElementById('grafico_pizza');

    new Chart(grafico_pie, {
        type: 'doughnut',
        data: {
            labels: ['Estufas críticas', 'Estufas preocupantes', 'Estufas adequadas'],
            datasets: [{
                label: 'Situação das estufas',
                data: [6, 2, 17],
                backgroundColor: ['Red', 'Yellow', 'Green'],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>


<script>

    window.addEventListener("load", () => {
            obterEstufas();
            maiorMenorIndice();
            obterCaptacoes();
            rankMaisAlertas();
        });

        

    var idEmpresa = sessionStorage.idUsuario;

    loginUsuario.innerHTML = sessionStorage.NOME_USUARIO


    let proximaAtualizacao;

    var listaDeEstufas = []


    function obterEstufas() {
        fetch("/estufa/exibirEstufas", {
            method: "post",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idEmpresa
            })
        }).then((listaEstufas) => {
            listaEstufas.json().then((listaEstufas) => {
                for (i = 0; i < listaEstufas.length; i++) {
                    listaDeEstufas.push(listaEstufas[i])
                }

                obterDadosGraficos()
            })
        })
    }

    
function obterDadosGraficos() {

var limiteLinhasEstufa = listaDeEstufas.length

if (proximaAtualizacao != undefined) {
    clearTimeout(proximaAtualizacao);
}

fetch ("/leitura/buscarUltimasMedidas", {
    method: "post",
    headers: {
        "Content-Type": "application/json",
    },
    body: JSON.stringify({
        idUsuarioServer: idEmpresa
    }),
}).then((listaCaptacoes) =>{
    if(listaCaptacoes.ok){
        listaCaptacoes.json().then((listaCaptacoes)=>{

            plotarGrafico(listaCaptacoes, idEmpresa)
        });
    } else {
        console.error("nenhum dado encontrado ou erro na API")
    }
})
}
    let estufas = []

    function plotarGrafico(resposta, idEmpresa) {

        console.log('iniciando plotagem do gráfico...');

        let labels = [resposta[0].leituraTime, resposta[0].leituraTime, resposta[0].leituraTime, resposta[0].leituraTime, resposta[0].leituraTime]; //data hora
        
        // Criando estrutura para plotar gráfico - labels
        
        let vetorComparativo = []

        for (let index = 0; index < resposta.length; index++) {
            let estufa = resposta[index];

            let test = estufas.findIndex(estufaChart => {
                return estufaChart.label == estufa.nome_estufa;
            });

            if (test == -1) {
                vetorComparativo.push(estufa);
                estufas.push({
                    label: estufa.nome_estufa, //nomw estufa
                    data: [0, 0, 0, 0], //media
                    fill: false,
                    borderColor: 'rgb(255, 255, 000)',
                    tension: 0.
                });
            }
        }

        for (let index = 0; index < resposta.length; index++) {
            let estufa = resposta[index];

            let test = estufas.findIndex(estufaChart => {
                return estufaChart.label == estufa.nome_estufa;
            });

            if (test > -1) {
                estufas[test].data.push(resposta[index].media_Valor)

                console.log("valor media da ", resposta[index].nome_estufa, ": ", resposta[index].media_Valor)
            }
        }


    let dados = {
        labels: labels,
        datasets: estufas
    };

    
    // Criando estrutura para plotar gráfico - dados
    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    const config = {
        type: 'line',
        data: dados,
        options: {}
    };


    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
        document.getElementById(`myChart1`),
        config
    );


                   
    setTimeout(() => atualizarGrafico(idEmpresa, dados, myChart), 1000);

}



    function atualizarGrafico(idEmpresa, dados, myChart) {

        fetch(`/leitura/tempoReal/${idEmpresa}`,
            { cache: 'no-store' }).
            then(function (response) {
                if (response.ok) {
                    response.json().then(function (novosRegistros) {
                            console.log("uqueeeeeeeeeeee",novosRegistros)
                        // obterDadosGraficos(idEmpresa);
                        // alertar(novoRegistro, idAquario);
                        console.log(`Dados recebidos: ${JSON.stringify(novosRegistros)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(dados);

                        // let avisoCaptura = document.getElementById(`avisoCaptura${idEmpresa}`)
                        // avisoCaptura.innerHTML = ""


                        if (novosRegistros[0].leituraTime == dados.labels[dados.labels.length - 1]) {
                            console.log("---------------------------------------------------------------")
                            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                            // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                            console.log("Horário do novo dado capturado:")
                            console.log(novosRegistros[0].leituraTime)
                            console.log("Horário do último dado capturado:")
                            console.log(dados.labels[dados.labels.length - 1])
                            console.log("---------------------------------------------------------------")
                        } else {
                            for (let index = 0; index < novosRegistros.length; index++) {
                                    let estufa = novosRegistros[index];

                                    let test = estufas.findIndex(estufaChart => {
                                        return estufaChart.label == estufa.nome_estufa;
                                    });

                                    if (test > -1) {
                                        dados.labels.shift();
                                        dados.labels.push(novosRegistros[0].leituraTime);

                                        dados.datasets[test].data.shift();
                                        dados.datasets[test].data.push(novosRegistros[index].media_Valor);
                                        // tem um vetor com test e outro com text
                                                                           //   ||
                                   }
                                }


                            // tirando e colocando valores no gráfico
                             // apagar o primeiro
                             // incluir um novo momento

                              // apagar o primeiro de umidade
                             // incluir uma nova medida de umidade

                            // dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                            // dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                            myChart.update();
                        }

                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idEmpresa, dados, myChart), 2000);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idEmpresa, dados, myChart), 2000);
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>

<script>








    function rankMaisAlertas() {
        fetch("/estufa/rankMaisAlertas", {
            method: "post",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idEmpresa,
            }),
        }).then((listaRankMaisAlertas) => {
            listaRankMaisAlertas.json().then((listaRankMaisAlertas) => {
                console.log("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA", listaRankMaisAlertas)
                for (i = 0; i < listaRankMaisAlertas.length; i++) {
                    rankEstufas.innerHTML += `
                            <div class="mencionar_estufa1">
                                ${listaRankMaisAlertas[i].nome_estufa}
                            </div>
                        `
                }
            })
        })
    }

    function maiorMenorIndice() {
        fetch("/leitura/obterMenorIndice", {
            method: "post",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idEmpresa,
            }),
        }).then((menorIndice) => {
            if (menorIndice.ok) {
                fetch("/leitura/obterMaiorIndice", {
                    method: "post",
                    headers: {
                        "Content-type": "application/json"
                    },
                    body: JSON.stringify({
                        idUsuarioServer: idEmpresa,
                    }),
                }).then((maiorIndice) => {
                    menorIndice.json().then((menorIndice) => {
                        maiorIndice.json().then((maiorIndice) => {
                            console.log(maiorIndice)
                            mmIndice.innerHTML = ` 
                                <div class="alto_indice_luz">
                                        <div class="maior_indice_luz">
                                            MAIOR ÍNDICE DE LUZ CAPTADO <br>
                                            <p>${maiorIndice[0].valor_maximo}</p>
                                        </div>
                                        <div class="indicacao_estufa">
                                            ${maiorIndice[0].nome_estufa} - setor ${maiorIndice[0].idSetor} - sensor ${menorIndice[0].idSensor}
                                        </div>
                                        <span class="hora"><img src="../assets/imgs/relogio.svg">${maiorIndice[0].horaLeitura}</span>

                                </div>
                                    `

                            mmIndice.innerHTML += `
                                <div class="baixo_indice_luz">
                                        <div class="menor_indice_luz">
                                            MENOR ÍNDICE DE LUZ CAPTADO<br>
                                            <p>${menorIndice[0].valor_minimo}</p>
                                            <div class="indicacao_estufa">
                                                ${menorIndice[0].nome_estufa} - setor ${menorIndice[0].idSetor} - sensor ${menorIndice[0].idSensor}
                                            </div>
                                            <span style="color: #6D2D2D;" class="hora"><img
                                                    src="../assets/imgs/relogio.svg">${menorIndice[0].horaLeitura}</span>
                                        </div>
                                    </div>
                                `
                        })
                    })
                })
            }
        })
    }




    //  ALERTAS


    setInterval(obterCaptacoes, 150000)


    function obterCaptacoes() {
        console.log("entrando na function obeter captacoes")
        listaAlert.innerHTML = ""

        fetch(`/leitura/obterCaptacoes`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            })
        }).then(function (listaCaptacoes) {
            listaCaptacoes.json().then(function (listaCaptacoes) {
                for (i = 0; i < listaCaptacoes.length; i++) {

                    if (listaCaptacoes[i].indiceAtual < 450 || listaCaptacoes[i].indiceAtual > 650) {
                        listaAlert.innerHTML += `                        
                            <a class="click-alert" href="setor1.html">
                                <div class="containerAlert">
                                    <div class="alert">
                                        <div class="img">
                                            <img class="img-alert" src="../assets/imgs/alert-icon.svg" alt="">
                                        </div>
                                        <div class="macacoo" style="display: flex; flex-direction: column; justify-content: center; gap: 10px; width: 205px;">
                                            <div class="urgenteEst">
                                                <span class="urgente">Estufa ${listaCaptacoes[i].nomeEstufa}</span>
                                                <span class="urgente">Setor ${listaCaptacoes[i].idSetor}</span>
                                                <span>Subsetor ${listaCaptacoes[i].idSubSetor}</span>
                                            </div>

                                            <div class="alerts">
                                                <div class="text-valores">
                                                     <span class="text-atual">ÍNDICE ATUAL: ${listaCaptacoes[i].indiceAtual}lm</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; width: 100%;">
                                                     <span class="hora"><img src="../assets/imgs/relogio.svg">${listaCaptacoes[i].horarioLeitura}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                 </div>
                            </a>`
                    }
                }

                for (i = 0; i < listaCaptacoes.length; i++) {
                    if (listaCaptacoes[i].indiceAtual >= 450 && listaCaptacoes[i].indiceAtual < 500 || listaCaptacoes[i].indiceAtual > 600 && listaCaptacoes[i].indiceAtual <= 650) {
                        listaAlert.innerHTML += `
                        <a class="click-alert-preocupante" href="setor1.html">
                            <div class="containerAlert">
                                <div class="alert-preocupante">
                                    <div class="img">
                                        <img class="img-alert" src="../assets/imgs/vectorPreocupante.svg">
                                    </div>

                                    
                                    <div class="mimir">
                                        <div class="urgenteEst-preocupante">
                                            <span class="urgente">Estufa ${listaCaptacoes[i].nomeEstufa}</span>
                                            <span class="urgente">Setor ${listaCaptacoes[i].idSetor}</span>
                                            <span>Subsetor ${listaCaptacoes[i].idSubSetor}</span>
                                            <span class="preocupante-valor">ÍNDICE ATUAL: ${listaCaptacoes[i].indiceAtual}lm</span>
                                        </div>
                                        
                                        <div class="alerts-preocupante">                  

                                            <div class="horario">
                                                <span class="hora-preocupante"><img src="../assets/imgs/relogio.svg">${listaCaptacoes[i].horarioLeitura}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                            `
                    }
                }
            })

        })
    }


</script>

</html>