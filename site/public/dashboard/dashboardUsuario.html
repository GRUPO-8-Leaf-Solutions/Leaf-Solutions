<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Leaf - Dashboard</title>

    <link rel="icon" href="../../assets/icon/logo.svg">
    <link rel="stylesheet" href="css/dashboardPage.css">

    <!-- SCRIPT PARA PUXAR A BIBLIOTECA DO CHARTJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
</head>
<!-- onload="coletarMaiorIndice, coletarMaiorIndice" -->

<body>
    <!-- PAG MENU -->
    <div class="container">

        <div class="lateral">
            <!-- parte de cima -->
            <div class="listaBaixo">
                <div class="navegacão">
                    <div class="navHeader">
                        <img src="../assets/icon/logo.svg">
                        <span>MENU</span>
                    </div>
                    <ul>
                        <li class="lista destaque">
                            <a href="dashboardUsuario.html">
                                <i class="uil uil-create-dashboard"></i>
                                <span class="lista">Dashboard</span>
                            </a>
                        </li>
                        <li class="lista">
                            <a href="estatisticaUsuario.html">
                                <i class="uil uil-presentation-line"></i>
                                <span class="lista">Estatística</span>
                            </a>
                        </li>
                        <!-- <li class="lista">
                            <a href="previsaoPage.html">
                                <i class="uil uil-chart-pie"></i>
                                <span class="lista">Previsões</span>
                            </a>
                        </li> -->
                        <!-- <li class="lista">
                            <a href="historicoPage.html">
                                <i class="uil uil-history"></i>
                                <span class="lista">Histórico</span>
                            </a>
                        </li> -->
                    </ul>

                   <!--  <div class="inferior-menu" style="background-image: url(../assets/imgs/VectorPéMenu.svg);">
                        <ul style="height: fit-content;">
                            <li class="lista">
                                <a href="cadastrarUsuario.html">
                                    <i class="uil uil-plus-circle"></i>
                                    <span class="lista" style="font-size: 15px;">Cadastrar usuario</span>
                                </a>
                            </li>
                            <li class="lista">
                                <a href="cadastrarEstufa.html">
                                    <i class="uil uil-plus-circle"></i>
                                    <span class="lista" style="font-size: 15px;">Cadastrar estufa</span>
                                </a>
                            </li>
                             <img src="imgs/VectorPéMenu.svg" alt="">
                        </ul>
                    </div> -->

                </div>

                <!-- parte de baixo -->
                <!-- <div class="trindade">
                    <div class="configNomeimg">
                        <div class="nomeNome">
                            <img src="imgs/Ellipse2325.png">
                            <ul class="ul2">
                                <span class="ismalendas">
                                    <span>NomeUsuario</span>
                                    <span>NomeEmpresa</span>
                                </span>
                            </ul>
                        </div> -->

                <!-- <div class="configgg">
                            <a href="#">
                                <i class="uil uil-setting"></i>
                            </a>
                            <a href="../home/login.html">
                                <i class="uil uil-signout" style="color: #C63535;"></i>
                            </a>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>
        <!-- FIM DO MENU -->

        <!-- parte do dash -->
        <div class="tela">
            <div class="top">
                <div class="top-left">
                    <span class="topo">Dashboard</span>
                </div>
                <div class="nomeNome">
                    <a href="../login.html">
                        <i class="uil uil-signout"></i>
                    </a>

                    <ul class="ul2">
                        <span class="ismalendas">
                            <span id="loginUsuario">EMPRESA</span>
                        </span>
                    </ul>
                </div>
            </div>
            <div class="areaDash">

                <div class="alertsParametro">
                    <div class="urgente">
                        <img src="../assets/imgs/vetorUrgente.svg">
                        <div class="span-urgente">
                            <span class="urgenteText">CRÍTICO</span>
                            <span>350lm - 449lm</span>
                            <span>650lm - 800lm</span>
                        </div>
                    </div>
                    <div class="preocupante">
                        <img src="../assets/imgs/VectorNewProcupante.svg" width="30px">
                        <div class="span-preocupante">
                            <span class="criticoText">PREOCUPANTE</span>
                            <span>450lm - 499lm</span>
                            <span>600lm - 649lm</span>
                        </div>
                    </div>
                    <!-- <div class="critico">
                            <img src="../imgs/vectorPreocupante.svg" width="30px">
                            <span class="preocupanteText">PREOCUPANTE</span>
                        </div> -->
                    <div class="adequado">
                        <img src="../assets/imgs/vetorAdequado.svg">
                        <div class="span-adequado">
                            <span class="adequadoText">ADEQUADO</span>
                            <span>500lm - 559lm</span>
                        </div>
                    </div>
                </div>

            </div>
            <div class="tela-dashboard">






                <div class="daddy">
                    <div class="main">


                        <div class="containerChart">
                            <div class="tittle_chart">
                                <span>
                                    MEDIA DA LUMINOSIDADE DAS ESTUFAS NAS ULTIMAS 24H
                                </span>
                            </div>
                            <canvas id="myChart1"></canvas>
                        </div>
                        <!-- <div class="containerChart">
                        <div class="chartContainer">
                            <div class="grafico1">
                                <span class="title-Chart"></span>
                                <span class="subTittle-Chart">EM CADA ESTUFA</span>
                            </div>
                        </div>
                    </div> -->

                        <div class="rodape">


                            <div class="indice_luz_pai">
                                <div class="mmIndice">

                                    <div class="mmIndiceKpi">
                                        <div>
                                            <i class="uil uil-sun"></i>
                                            <span>Maior indice captado</span>
                                        </div>

                                        <div>
                                            <span id="maiorIndiceC">000lm</span>
                                            <span id="maiorIndiceH">00:00:00</span>
                                        </div>

                                        <div>
                                            <span id="maiorIndiceN">NomeEstufa</span>
                                            <span id="maiorIndiceS">Setor X</span>
                                            <span id="maiorIndiceSS">Subsetor X</span>
                                            <span id="maiorIndiceSSor">Sensor X</span>
                                        </div>
                                    </div>

                                    <div class="mmIndiceKpi">
                                        <div>
                                            <i class="uil uil-cloud-sun"></i>
                                            <span>Menor indice captado</span>
                                        </div>

                                        <div>
                                            <span id="menorIndiceC">000lm</span>
                                            <span id="menorIndiceH">00:00:00</span>
                                        </div>

                                        <div>
                                            <span id="menorIndiceN">NomeEstufa</span>
                                            <span id="menorIndiceS">Setor X</span>
                                            <span id="menorIndiceSS">Subsetor X</span>
                                            <span id="menorIndiceSSor">Sensor X</span>
                                        </div>
                                    </div>

                                </div>

                                <div class="rankEstufas">
                                    <span>Estufas com mais alertas</span>

                                    <div id="listaRank" class="listaRank">

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ALERTA URGENTE -->
                    <div class="lado_direito">
                        <div class="tela-alertas">
                            <span class="title-alerta">ALERTAS</span>

                            <div class="listaScroller" id="listaAlert"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</body>


<script>
    loginUsuario.innerHTML = sessionStorage.NOME_USUARIO


    
    window.addEventListener("load", () => {
        obterEstufas();
        obterUltimasCapturasAlertas();
        maiorMenorIndice();
        rankMaisAlertas();
        obterSituacao();
    });

    const grafico_pie = document.getElementById('grafico_pizza');

    var idEmpresa = sessionStorage.idUsuario;


    let proximaAtualizacao;

    var listaDeEstufas = []
    var qtdLinhas   

    console.log(qtdLinhas)

    function obterEstufas() {
        fetch("/estufa/exibirEstufas", {
            method: "post",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idEmpresa
            })
        }).then((listaEstufas) => {
            listaEstufas.json().then((listaEstufas) => {
                for (i = 0; i < listaEstufas.length; i++) {
                    listaDeEstufas.push(listaEstufas[i])
                }
            }).then(()=>{
                fetch("/estufa/qtdEstufas", {
                    method: "post",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        idUsuarioServer: idEmpresa
                    })
                }).then((qtdEstufas) => {
                    qtdEstufas.json().then((qtdEstufas) => {
                        qtdLinhas = qtdEstufas.length
                        console.log(qtdLinhas)

                        obterDadosGraficos()
                    })
                })
            })
        })
    }


    function obterDadosGraficos() {

        var limiteLinhasEstufa = qtdLinhas

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch("/leitura/buscarUltimasMedidas", {
            method: "post",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idEmpresa,
                qtdLinhasServer: qtdLinhas
            }),
        }).then((listaCaptacoes) => {
            if (listaCaptacoes.ok) {
                listaCaptacoes.json().then((listaCaptacoes) => {
                     listaCaptacoes.reverse()
                    plotarGrafico(listaCaptacoes, idEmpresa)
                });
            } else {
                console.error("nenhum dado encontrado ou erro na API")
            }
        })
    }
    let estufas = []

    function plotarGrafico(resposta, idEmpresa) {

        console.log('iniciando plotagem do gráfico...');

        let labels = []; //data hora

        // Criando estrutura para plotar gráfico - labels

        let vetorComparativo = []

        for (let index = 0; index < resposta.length; index++) {
            let estufa = resposta[index];
            console.log(resposta)
            let test = estufas.findIndex(estufaChart => {
                return estufaChart.label == estufa.nome_estufa;
            });

            if (test == -1) {
                vetorComparativo.push(estufa);
                estufas.push({
                    label: estufa.nome_estufa, //nomw estufa
                    data: [], //media
                    fill: false,
                    borderColor: 'rgb(255, 255, 000)',
                    tension: 0.1
                });
            }
        }



        for (let index = 0; index < resposta.length; index++) {
            let estufa = resposta[index];

            let test = estufas.findIndex(estufaChart => {
                return estufaChart.label == estufa.nome_estufa;
            });

            if (test > -1) {
                estufas[test].data.push(resposta[index].media_Valor)
                if(estufa.nome_estufa == estufas[0].label){
                    labels.push(resposta[index].ultima_leitura)
                }

                // if (labels.length < 5) {
                //     for (i = 0; i < 10; i++) {
                //         if (i % qtdLinhas == 0) {
                //             console.log("putaria", resposta[i])
                //             labels.push(resposta[i].ultima_leitura)
                //         }
                //     }
                // }
            }

        }


        let dados = {
            labels: labels,
            datasets: estufas
        };


        // Criando estrutura para plotar gráfico - dados
        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        const config = {
            type: 'line',
            data: dados,
            options: {
                aspectRatio: 1 | 2
            }
        };


        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChart1`),
            config
        );



     setTimeout(() => atualizarGrafico(idEmpresa, dados, myChart), 1000);

    }



    function atualizarGrafico(idEmpresa, dados, myChart) {

        fetch(`/leitura/tempoReal/${idEmpresa}`,
            { cache: 'no-store' }).
            then(function (response) {
                if (response.ok) {
                    response.json().then(function (novosRegistros) {

                        // obterDadosGraficos(idEmpresa);
                        // alertar(novoRegistro, idAquario);
                        console.log(`Dados recebidos: ${JSON.stringify(novosRegistros)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(dados.labels);

                        // let avisoCaptura = document.getElementById(`avisoCaptura${idEmpresa}`)
                        // avisoCaptura.innerHTML = ""


                        if (novosRegistros[0].ultima_leitura == dados.labels[dados.labels.length - 1]) {
                            console.log("---------------------------------------------------------------")
                            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                            // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                            console.log("Horário do novo dado capturado:")
                            console.log(novosRegistros[0].ultima_leitura)
                            console.log("Horário do último dado capturado:")
                            console.log(dados.labels[dados.labels.length - 1])
                            console.log("---------------------------------------------------------------")
                        } else {
                            console.log("putaria2000", novosRegistros)
                            for (let index = 0; index < novosRegistros.length; index++) {

                                let estufa = novosRegistros[index];
                                        console.log(estufa)

                                let test = estufas.findIndex(estufaChart => {
                                    return estufaChart.label == estufa.nome_estufa;
                                });

                                console.log("putaria", test)

                                if (test > -1) {
                                    dados.labels.shift();
                                    dados.labels.push(novosRegistros[0].ultima_leitura);

                                    dados.datasets[test].data.shift();

                                    dados.datasets[test].data.push(novosRegistros[index].media_valor);
                                    // tem um vetor com test e outro com text
                                    //   ||
                                }
                            }

                            myChart.update();
                        }

                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idEmpresa, dados, myChart), 2000);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idEmpresa, dados, myChart), 2000);
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }


    var teste
    
    function obterSituacao() {
        fetch("/leitura/obterSituacao", {
            method: "post",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            })
        }).then((listaParam) => {
            listaParam.json().then((listaParam) => {
                console.log("entruo")
                var paramEstufa = []

                for (i = 0; i < listaParam.length; i++) {
                    console.log("foi?", listaParam)

                    if (listaParam[i].idAlerta == 1) {
                            paramEstufa[0] = listaParam[i].qtdEstufas;
                        } else if (listaParam[i].idAlerta == 2) {
                            paramEstufa[1] = listaParam[i].qtdEstufas;
                        } else if (listaParam[i].idAlerta == 3) {
                            paramEstufa[2] = listaParam[i].qtdEstufas;
                        } 
                    
                }
                console.log(paramEstufa)

                 teste = new Chart(grafico_pie, {
                    type: 'doughnut',
                    data: {
                        labels: ['Estufas críticas', 'Estufas preocupantes', 'Estufas adequadas'],
                        datasets: [{
                            label: 'Situação das estufas',
                            data: paramEstufa,
                            backgroundColor: ['Red', 'Yellow', 'Green'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

            })
        })
    }

setInterval (()=>{
    teste.update()
}, 1000)

</script>

<script>


    function rankMaisAlertas() {
        fetch("/estufa/rankMaisAlertas", {
            method: "post",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idEmpresa,
            }),
        }).then((listaRankMaisAlertas) => {
            listaRankMaisAlertas.json().then((listaRankMaisAlertas) => {
                for (i = 0; i < listaRankMaisAlertas.length; i++) {
                    listaRank.innerHTML += `<span>${listaRankMaisAlertas[i].nome_estufa} </span>`
                }
            })
        })
    }

    function maiorMenorIndice() {
        fetch("/leitura/obterMenorIndice", {
            method: "post",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify({
                idUsuarioServer: idEmpresa,
            }),
        }).then((menorIndice) => {
            if (menorIndice.ok) {
                fetch("/leitura/obterMaiorIndice", {
                    method: "post",
                    headers: {
                        "Content-type": "application/json"
                    },
                    body: JSON.stringify({
                        idUsuarioServer: idEmpresa,
                    }),
                }).then((maiorIndice) => {
                    menorIndice.json().then((menorIndice) => {
                        maiorIndice.json().then((maiorIndice) => {
                            console.log(maiorIndice)

                            maiorIndiceC.innerHTML = `${maiorIndice[0].valor_maximo}lm`
                            maiorIndiceH.innerHTML = `${maiorIndice[0].horaLeitura}`

                            maiorIndiceN.innerHTML = `${maiorIndice[0].nome_estufa}`
                            maiorIndiceS.innerHTML = `Setor ${maiorIndice[0].idSetor}`
                            maiorIndiceSS.innerHTML = `SubSetor ${maiorIndice[0].idSubsetor}`
                            maiorIndiceSSor.innerHTML = `Sensor ${menorIndice[0].idSensor}`

                            menorIndiceC.innerHTML = `${menorIndice[0].valor_minimo}lm`
                            menorIndiceH.innerHTML = `${menorIndice[0].horaLeitura}`

                            menorIndiceN.innerHTML = `${menorIndice[0].nome_estufa}`
                            menorIndiceS.innerHTML = `Setor ${menorIndice[0].idSetor}`
                            menorIndiceSS.innerHTML = `SubSetor ${menorIndice[0].idSubsetor}`
                            menorIndiceSSor.innerHTML = `Sensor ${menorIndice[0].idSensor}`

                        })
                    })
                })
            }
        })
    }


    //  ALERTAS
    setInterval(obterUltimasCapturasAlertas, 10000)
    setInterval(maiorMenorIndice, 60000)
    setInterval(obterSituacao, 60000)
    

    function obterUltimasCapturasAlertas() {
        console.log("entrando na function obter captacoes")
        listaAlert.innerHTML = ""

        fetch(`/leitura/obterUltimasCapturasAlertas`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            })
        }).then(function (listaCaptacoes) {
            listaCaptacoes.json().then(function (listaCaptacoes) {
                for (i = 0; i < listaCaptacoes.length; i++) {

                    if (listaCaptacoes[i].fkAlerta == 1) {

                        listaAlert.innerHTML += `                        
                            <div class="listaElement bgCritico">
                                    <div class="infoTopPart">
                                        <img src="../assets/imgs/vetorUrgente.svg" alt="">

                                        <div class="alertInformacoes">
                                            <div class="infosText color-critico">
                                                <span>Estufa ${listaCaptacoes[i].nomeEstufa}</span>
                                                <span>Setor  ${listaCaptacoes[i].idSetor}</span>
                                                <span>SubSetor  ${listaCaptacoes[i].idSubSetor}</span>
                                            </div>
                                            
                                            <div class="infosTextTime colorTimeCritico">
                                                <i class="uil uil-clock"></i>
                                                <span>${listaCaptacoes[i].horarioLeitura}</span>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="infoBottomPart bottom-bgColorCritico">
                                        <span>Sensor ${listaCaptacoes[i].idSensor}</span>
                                        <div>
                                            <span>${listaCaptacoes[i].indiceAtual}lm</span>
                                            <i class="uil uil-lightbulb-alt"></i>
                                        </div>
                                    </div>
                                </div>

                            `

                    }
                }

                for (i = 0; i < listaCaptacoes.length; i++) {
                    if (listaCaptacoes[i].fkAlerta == 2) {
                        listaAlert.innerHTML += `
                        <div class="listaElement bgPreocupante">
                                    <div class="infoTopPart">
                                        <img src="../assets/imgs/VectorNewProcupante.svg" alt="">

                                        <div class="alertInformacoes">
                                            <div class="infosText color-preocupante">
                                                <span>Estufa ${listaCaptacoes[i].nomeEstufa}</span>
                                                <span>Setor ${listaCaptacoes[i].idSetor}</span>
                                                <span>SubSetor ${listaCaptacoes[i].idSubSetor}</span>
                                            </div>
                                            
                                            <div class="infosTextTime colorTimePreocupante">
                                                <i class="uil uil-clock"></i>
                                                <span> ${listaCaptacoes[i].horarioLeitura}</span>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="infoBottomPart bottom-bgColorPreocupante">
                                        <span>Sensor  ${listaCaptacoes[i].idSensor}</span>
                                        <div>
                                            <span>${listaCaptacoes[i].indiceAtual}lm</span>
                                            <i class="uil uil-lightbulb-alt"></i>
                                        </div>
                                    </div>
                                </div>
                            `
                    }
                }
            })
        })
    }
</script>

</html>