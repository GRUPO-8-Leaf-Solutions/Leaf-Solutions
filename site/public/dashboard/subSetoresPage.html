<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/subSetores.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
    <link rel="stylesheet" href="../js/funcoes.js">
</head>

<body>
    <div class="container">

        <div class="lateral">
            <!-- parte de cima -->
            <div class="listaBaixo">
                <div class="navegacão">
                    <div class="navHeader">
                        <img src="../assets/icon/logo.svg">
                        <span>MENU</span>
                    </div>
                    <ul>
                        <li class="lista">
                            <a href="dashboardPage.html">
                                <i class="uil uil-create-dashboard"></i>
                                <span class="lista">Dashboard</span>
                            </a>
                        </li>
                        <li class="lista destaque">
                            <a href="estatisticaPage.html">
                                <i class="uil uil-presentation-line est"></i>
                                <span class="lista">Estatística</span>
                            </a>
                        </li>
                        <!-- <li class="lista">
                          <a href="historicoPage.html">
                            <i class="uil uil-history"></i>
                            <span class="lista">Histórico</span>
                          </a>
                        </li> -->
                    </ul>
                    <div class="inferior-menu" style="background-image: url(../assets/imgs/VectorPéMenu.svg);">
                        <ul style="height: fit-content;">
                            <li class="lista">
                                <a href="cadastrarUsuario.html">
                                    <i class="uil uil-plus-circle"></i>
                                    <span class="lista" style="font-size: 15px;">Cadastrar usuario</span>
                                </a>
                            </li>
                            <li class="lista">
                                <a href="cadastrarEstufa.html">
                                    <i class="uil uil-plus-circle"></i>
                                    <span class="lista" style="font-size: 15px;">Cadastrar estufa</span>
                                </a>
                            </li>
                            <!-- <img src="imgs/VectorPéMenu.svg" alt=""> -->
                        </ul>
                    </div>

                </div>
            </div>
        </div>
        <div class="tela">
            <div class="top">
                <div class="top-left">
                    <span class="topo">Dashboard</span>
                </div>
                <div class="nomeNome">
                    <ul class="ul2">
                        <span class="ismalendas">
                            <span id="loginUsuario"></span>
                            <span>NomeEmpresa</span>
                        </span>
                    </ul>
                </div>
            </div>
            <div class="areaDash">
                <div class="alertsParametro">
                    <div class="urgente">
                        <img src="../assets/imgs/vetorUrgente.svg">
                        <div class="span-urgente">
                            <span class="urgenteText">CRÍTICO</span>
                            <span>350lm - 450lm</span>
                            <span>650lm - 800lm</span>
                        </div>
                    </div>
                    <div class="preocupante">
                        <img src="../assets/imgs/VectorNewProcupante.svg" width="30px">
                        <div class="span-preocupante">
                            <span class="criticoText">PREOCUPANTE</span>
                            <span>450lm - 500lm</span>
                            <span>600lm - 650lm</span>
                        </div>
                    </div>
                    <!-- <div class="critico">
                        <img src="../imgs/vectorPreocupante.svg" width="30px">
                        <span class="preocupanteText">PREOCUPANTE</span>
                    </div> -->
                    <div class="adequado">
                        <img src="../assets/imgs/vetorAdequado.svg">
                        <div class="span-adequado">
                            <span class="adequadoText">ADEQUADO</span>
                            <span>500lm - 600lm</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="gap_entre_buscas_listaSensores">
                <div class="buscaInputListaSSos">
                    <!-- <div class="buscas">
                    <div class="subsetor">
                        <div class="buscar_subsetor">
                            <div>
                                <img src="../assets/imgs/Vector.svg">
                            </div>
                            <div>
                                <span>
                                    Buscar subsetor
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="sensor">
                        <div class="buscar_sensor">
                            <div>
                                <img src="../assets/imgs/Vector.svg">
                            </div>
                            <div>
                                <span>
                                    Buscar sensor
                                </span>
                            </div>
                        </div>
                    </div>
                </div> -->

                    <div class="subsetor_sensor_grafico">
                        <div class="gap_entre_subsetores_sensores">

                            <div id="pai_de_todo_subsetor" class="pai_de_todo_subsetor">

                                <div class="titulo_subsetor">
                                    Subsetores
                                </div>

                                <div class="listaSubSetor" id="listaSubSetor">

                                </div>

                            </div>

                            <div class="pai_de_todo_sensor">

                                <div class="titulo_sensor">
                                    <span>
                                        Sensores
                                    </span>
                                </div>

                                <div class="listaSensor" id="listaSensor">

                                </div>


                            </div>
                        </div>
                    </div>
                </div>

                <div class="segunda_parte">
                    <div class="alertas">
                        <div class="primeiro_alerta">
                            <div class="titulo_primeiro_alerta">
                                <span>Status do sensor</span>
                            </div>
                            <div class="ligado" id="status_sensor">
                                LIGADO
                            </div>
                        </div>
                        <div class="segundo_alerta">
                            <div class="titulo_segundo_alerta">
                                <span>Valor atual de luminosidade</span>
                            </div>
                            <div class="intensidade">
                                <div>
                                    <img src="../assets/imgs/vetorAdequado.svg" style="height: 25px">
                                </div>
                                <div id="intesidade_atual_sensor">
                                    <!-- INTERNSIDADE ATUAL DO SENSOR -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ajustes_graficos">
                        <div class="grafico">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>
                    <div class="cadeia_KPI">
                        <div class="KPI_esquerda">
                            <div class="KPI1_esquerda">
                                <div>
                                    <span>Maior intensidade captada</span>
                                </div>
                                <div class="ajuste_KPI">
                                    <div>
                                        <img src="../assets/imgs/alert-icon.svg">
                                    </div>
                                    <div id="maior_intensidade_captada">
                                        <!-- MAIOR INTENSIDADE CAPTADA -->
                                    </div>
                                </div>
                                <div class="ajuste_KPI">
                                    <div>
                                        <img src="../assets/imgs/relogio.svg">
                                    </div>
                                    <div id="horario_captacao_maior_captura">
                                        <!-- HORARIO DA MAIOR CAPTURA  -->
                                    </div>
                                </div>
                            </div>
                            <div class="KPI2_esquerda">
                                <div>
                                    <span>
                                        Menor intensidade captada
                                    </span>
                                </div>
                                <div class="ajuste_KPI">
                                    <div>
                                        <img src="../assets/imgs/alert-icon.svg">
                                    </div>
                                    <div id="menor_intensidade_captada">
                                        <!-- MENOR INTENSIDADE CAPTADA -->
                                    </div>
                                </div>
                                <div class="ajuste_KPI">
                                    <div>
                                        <img src="../assets/imgs/relogio.svg">
                                    </div>
                                    <div id="horario_captacao_menor_captura">
                                        <!-- HORARIO DA MENOR CAPTURA -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="KPI_direita">
                            <div class="conjunto_KPI">
                                <div class="KPI_1_1">
                                    <div>
                                        <span>
                                            Tempo fora do ideal
                                        </span>
                                    </div>
                                    <div id="fora_ideal_sensor">
                                        <!-- 10h 30m // QUANTIDADE TEMPO FORA DO IDEAL -->
                                    </div>
                                </div>
                                <div class="KPI_1_2">
                                    <div>
                                        <span>
                                            Tempo dentro do ideal
                                        </span>
                                    </div>
                                    <div id="dentro_ideal_sensor">
                                        <!-- 2h 40m QUANTIDADE TEMPO DENTRO DO IDEAL-->
                                    </div>
                                </div>
                            </div>
                            <div class="KPI2_direita">
                                <div>
                                    <span>
                                        Tempo ideal de exposição ao sol
                                    </span>
                                </div>
                                <div>
                                    <span>
                                        16h
                                    </span>
                                </div>
                            </div>
                            <div class="KPI3_direita">
                                <div>
                                    <span>
                                        Tempo faltante para o ideal
                                    </span>
                                </div>
                                <div class="ajuste_KPI">
                                    <div>
                                        <img src="../assets/imgs/vectorPreocupante.svg" style="height: 20px">
                                    </div>
                                    <div id="tempo_faltante_para_ideal">
                                        <!-- 6h 30m TEMPO RESTANTE PARA CHEGAR NO IDEAL-->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>

<script>
    const ctx = document.getElementById('myChart');

    // PRECISAMOS DO idSetor E  idSubSetor
    var idSetorVar = sessionStorage.setorClicado;
    var idEstufa = sessionStorage.estufaClicada;
    var idSubSetor = sessionStorage.subSetorClicado;
    var idEmpresa = sessionStorage.idUsuario;
    var idSensor = sessionStorage.sensorClicado;

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['14:10', '14:25', '14:40', '15:55', '15:10', '15:25'],
            datasets: [{
                label: '# of Votes',
                data: [12, 19, 3, 5, 2, 3],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });


    // function buscaSubSetor (){
    //     fetch("/subSetores/buscaSensor", {
    //         method: "post",
    //         headers: {
    //             "Content-type": "application/json"
    //         },
    //         body:JSON.stringify({
    //             idSubSetorServer: idSetorVar
    //         }),
    //     }).then((listaSubSetores)=>{
    //         listaSubSetores.json().then((listaSubSetores)=>{
    //             console.log(listaSubSetores)
    //         })
    //     })
    // }

    window.addEventListener("load", () => {
        BuscarSubSetor()
    })

    function BuscarSubSetor() {
        fetch("/subSetores/buscarSubSetor", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({

                idSetorServer: idSetorVar

            })
        }).then(function (listaSubSetores) {
            console.log("resposta: ", listaSubSetores);
            if (listaSubSetores.ok) {
                listaSubSetores.json().then((listaSubSetores) => {
                    console.log(listaSubSetores)
                    for (let i = 0; i < listaSubSetores.length; i++) {
                        var subsetor = listaSubSetores[i];
                        listaSubSetor
                            .innerHTML += `
                    <div onclick="pegarIdSubSetor(this.id)" id="${subsetor.subSetor}" class="subsetor_critico">
                    <span>Subsetor ${i + 1} </span>
                    </div>
                    `
                    }
                })
            } else {
                throw ("Houve um erro na API ou em trazer os dados !!")
            }
        }).catch(function (resposta) {
            console.log(`#ERROR: ${resposta}`);
        });
        return false;
    }


    // <div class="subsetor_critico" id="lista_subsetores">
    //     <span>Subsetor <span id="idSubSetor"></span></span>
    // </div>

    function buscarSensor() {

        fetch("/subSetores/buscarSensor", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({


                idSubSetorServer: idSubSetor


            })

        }).then(function (listaSensores) {
            console.log("resposta: ", listaSensores);
            if (listaSensores.ok) {
                listaSensores.json().then((listaSensores) => {
                    console.log(listaSensores)
                    for (let i = 0; i < listaSensores.length; i++) {
                        var sensorAtual = listaSensores[i];
                        console.log("Lista de sensores" + listaSensores)
                        listaSensor.innerHTML = `
                        <div class="lista_sensor" onclick="pegarIdSensor(this.id)" id="${sensorAtual.Sensor}">
                                <div>
                                    <img class="imgSensor" src="../assets/imgs/alert-icon.svg">
                                </div>

                                <div>
                                    <span>Sensor <span id="idSensor">${i + 1}</span></span>
                                </div>
                                <label>
                                    <input type="checkbox" class="toggle_input">
                                    <div class="toggle-wrapper">
                                        <div class="slider">
                                            <button class="button"></button>
                                        </div>

                                </label>
                            </div>
                            `

                    }
                })
            } else {
                throw ("Houve um erro na API ou em trazer os dados !!")
            }
        }).catch(function (listaSensores) {
            console.log(`#ERROR: ${listaSensores}`);
        });
        return false;


    }



    function pegarIdSubSetor(id) {
        sessionStorage.subSetorClicado = id;
        buscarSensor()
    }

    function pegarIdSensor(id) {
        sessionStorage.sensorClicado = id;
        maiorMenorIndice()
    }



    function maiorMenorIndice() {
        fetch("/subSetores/obterMenorIndice", {
            method: "post",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify({

                idUsuarioServer: idEmpresa,
                idSetorServer: idSetorVar,
                idEstufaServer: idEstufa,
                idSubSetorServer: idSubSetor,
                idSensorServer: idSensor

            }),
        }).then((menorIndice) => {
            if (menorIndice.ok) {
                fetch("/subSetores/obterMaiorIndice", {
                    method: "post",
                    headers: {
                        "Content-type": "application/json"
                    },
                    body: JSON.stringify({

                        idUsuarioServer: idEmpresa,
                        idSetorServer: idSetorVar,
                        idEstufaServer: idEstufa,
                        idSubSetorServer: idSubSetor,
                        idSensorServer: idSensor

                    }),
                }).then((maiorIndice) => {
                    menorIndice.json().then((menorIndice) => {
                        maiorIndice.json().then((maiorIndice) => {
                            console.log(maiorIndice)

                            maior_intensidade_captada.innerHTML = `${maiorIndice[0].valor_maximo}lm`
                            horario_captacao_maior_captura.innerHTML = `${maiorIndice[0].horaLeitura}`

                            menor_intensidade_captada.innerHTML = `${menorIndice[0].valor_minimo}lm`
                            horario_captacao_menor_captura.innerHTML = `${menorIndice[0].horaLeitura}`



                        })
                    })
                })
            }
        })
    }


</script>